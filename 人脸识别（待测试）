#include <Wire.h>
#include <Arduino.h>

// 定义通信命令帧格式
#define HEADER1 0x55
#define HEADER2 0xAA
#define ADDRESS 0x11

// 定义命令
#define COMMAND_REQUEST_KNOCK 0x2C      // 请求初始化命令
#define COMMAND_REQUEST_ALGORITHM 0x2D  // 切换算法命令
#define COMMAND_REQUEST_LEARN 0x36      // 学习面部命令
#define COMMAND_REQUEST_FORGET 0x37     // 遗忘面部命令
#define COMMAND_REQUEST_BLOCKS_LEARNED 0x24 // 请求已学习的块信息命令
#define COMMAND_RETURN_OK 0x2E           // 返回成功命令
#define COMMAND_RETURN_BUSY 0x3D         // 返回忙碌命令

// 定义算法
#define ALGORITHM_FACE_RECOGNITION 0x00  // 人脸识别算法

// 全局变量
int faceID = 1; // 动态管理ID
bool isFaceDetected = false; // 检查是否检测到人脸

// 向 HuskyLens 发送命令的函数
void sendCommand(byte command, byte dataLength, byte* data) {
  // 计算校验和
  byte checksum = HEADER1 + HEADER2 + ADDRESS + dataLength + command;
  for (int i = 0; i < dataLength; i++) {
    checksum += data[i];
  }
  
  // 发送命令帧
  Wire.beginTransmission(ADDRESS);
  Wire.write(HEADER1);
  Wire.write(HEADER2);
  Wire.write(ADDRESS);
  Wire.write(dataLength);
  Wire.write(command);
  for (int i = 0; i < dataLength; i++) {
    Wire.write(data[i]);
  }
  Wire.write(checksum);
  Wire.endTransmission();
}

// 从 HuskyLens 接收响应的函数
bool receiveResponse(byte* data, int dataLength) {
  Wire.requestFrom(ADDRESS, dataLength + 6); // 请求帧头和数据总长度
  if (Wire.available() >= dataLength + 6) {
    // 接收命令帧
    byte header1 = Wire.read();
    byte header2 = Wire.read();
    byte address = Wire.read();
    byte length = Wire.read();
    byte command = Wire.read();
    for (int i = 0; i < dataLength; i++) {
      data[i] = Wire.read();
    }
    byte checksum = Wire.read();

    // 验证校验和
    byte calculatedChecksum = header1 + header2 + address + length + command;
    for (int i = 0; i < dataLength; i++) {
      calculatedChecksum += data[i];
    }
    return (checksum == calculatedChecksum);
  }
  return false;
}

// 切换到人脸识别算法
void setFaceRecognitionAlgorithm() {
  byte data[] = {ALGORITHM_FACE_RECOGNITION, 0x00};  // 设置为人脸识别算法
  sendCommand(COMMAND_REQUEST_ALGORITHM, sizeof(data), data);

  // 检查响应
  byte response[1];
  if (receiveResponse(response, sizeof(response)) && response[0] == COMMAND_RETURN_OK) {
    Serial.println("切换到人脸识别算法成功。");
  } else {
    Serial.println("切换到人脸识别算法失败。");
  }
}

// 请求已学习的块信息
void requestLearnedBlocks() {
  sendCommand(COMMAND_REQUEST_BLOCKS_LEARNED, 0, NULL);
  byte response[10]; // 假设返回块的格式较大

  if (receiveResponse(response, sizeof(response))) {
    int centerX = response[0] | (response[1] << 8); // X 坐标
    int centerY = response[2] | (response[3] << 8); // Y 坐标
    int width = response[4] | (response[5] << 8);   // 宽度
    int height = response[6] | (response[7] << 8);  // 高度
    int detectedID = response[8];                   // ID

    Serial.print("人脸检测到的中心位置: (");
    Serial.print(centerX);
    Serial.print(", ");
    Serial.print(centerY);
    Serial.print("), 大小: ");
    Serial.print(width);
    Serial.print("x");
    Serial.println(height);
    Serial.print("检测到的ID: ");
    Serial.println(detectedID);

    isFaceDetected = true;
  } else {
    Serial.println("未检测到人脸。");
    isFaceDetected = false;
  }
}

// 执行面部识别的函数
void faceRecognition() {
  // 发送学习命令，动态ID
  byte data[] = {byte(faceID & 0xFF), byte((faceID >> 8) & 0xFF)}; // 动态学习ID
  sendCommand(COMMAND_REQUEST_LEARN, sizeof(data), data);

  // 接收响应
  byte response[2]; // 响应缓冲区
  if (receiveResponse(response, sizeof(response))) {
    if (response[0] == COMMAND_RETURN_OK) {
      Serial.println("面部学习成功。");
      faceID++; // 动态增加ID
    } else if (response[0] == COMMAND_RETURN_BUSY) {
      Serial.println("HuskyLens 正在忙碌，请稍后再试。");
    } else {
      Serial.println("学习面部时出错。");
    }
  }

  // 请求已学习的块信息
  requestLearnedBlocks();
  
  // 发送遗忘命令
  byte emptyData[] = {0x00};
  sendCommand(COMMAND_REQUEST_FORGET, 0, emptyData);

  // 接收响应
  if (receiveResponse(response, sizeof(response))) {
    if (response[0] == COMMAND_RETURN_OK) {
      Serial.println("面部遗忘成功。");
    } else if (response[0] == COMMAND_RETURN_BUSY) {
      Serial.println("HuskyLens 正在忙碌，请稍后再试。");
    } else {
      Serial.println("遗忘面部时出错。");
    }
  }
}

void setup() {
  Serial.begin(115200);
  Wire.begin();
  
  // 初始化 HuskyLens
  sendCommand(COMMAND_REQUEST_KNOCK, 0, NULL);
  
  // 接收响应
  byte response[2];
  if (receiveResponse(response, sizeof(response))) {
    if (response[0] == COMMAND_RETURN_OK) {
      Serial.println("HuskyLens 初始化成功。");
    } else {
      Serial.println("初始化 HuskyLens 时出错。");
    }
  }

  // 切换到人脸识别算法
  setFaceRecognitionAlgorithm();
}

void loop() {
  // 连续检测人脸
  faceRecognition();

  // 如果检测到人脸，可以增加其他处理逻辑
  if (isFaceDetected) {
    Serial.println("检测到人脸，执行进一步操作...");
  }

  delay(1000); // 设置较小的延时，保证连续检测
}
